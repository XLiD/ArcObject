# ArcObject .Net with VS 2013 #

Please take this repository as a memo to walk you through the AO setup, debug and development...

If you can't do, you teach :)


## Prerequisites: Installation##
## Lesson 1: Setup Environment and Debug ##
OK, let's start up our first AO project in VS2013! On menu bar: FILE -> New Project, then open the tree structure inside the left pane on the opening dialog, find Visual C# -> ArcGIS -> Desktop Add-ins -> ArcMap Add-in.

In the ArGIS Add-Ins Wizard, make sure to check "Button" option under Add-in Types. This will create a template of a button control for ArcMap.
You should be able to find a cs file with name "Button1.cs". Please replace this file with the on at [here](https://github.com/hellocomrade/arcobject/blob/master/lesson1/Button1.cs).
Before we build the button control, open Soultion Explorer of your VS 2013, right-click on the project name and choose properties. Double Check 2 places:

1. Target framework under Application section should be ".NET Framework 4";
2. Under Debug section, make sure the "Start external program" is set as your ArcMap program;

Still under Solution Explorer, right click on the References and choose "Add ArcGIS References...". We need the following two references in order to build this solution. They are not included by this default template:

1. ESRI.ArcGIS.Geometry
2. ESRI.ArcGIS.Carto

Now you are ready to build the solution! Before you do that, there is still some housekeeping we have to do on ArcMap end. Go to your ArcMap installation folder, usually it is located at: C:\Program Files (x86)\ArcGIS\Desktop10.3\bin, find a file named "ArcMap.exe.config". Open it up with administrator privilege. It is an XML file and search the following section located at the top of the file:
```xml
<startup>
    <!--<supportedRuntime version="v4.0.30319"/>-->
    <supportedRuntime version="v2.0.50727"/>
</startup>
```
By default, ArcMap is configured to run against .Net Framework Runtime 2.0, which is a conflict with the button control we are going to build in VS 2013. Comment out that line and uncomment the line above to enable .Net Framework Runtime 4.0 for ArcMap. OK, now you should be able to build it without any issue. In order to make sure we are on the same page for the following section, please check your "config.esriaddinx" file. You can find this file under Solution Explorer. Here is what I have (I did remove unrelated sections)
```xml
<ESRI.Configuration xmlns="http://schemas.esri.com/Desktop/AddIns" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <Name>ArcMapAddin1</Name>
  ......
  <Targets>
    <Target name="Desktop" version="10.3" />
  </Targets>
  <AddIn language="CLR4.0" library="ArcMapAddin1.dll" namespace="ArcMapAddin1">
    <ArcMap>
      <Commands>
        <Button id="ArcMapAddin1_Button1" class="Button1" message="Add-in command generated by Visual Studio project wizard." caption="My Button" tip="Add-in command tooltip." category="Add-In Controls" image="Images\Button1.png" />
      </Commands>
    </ArcMap>
  </AddIn>
</ESRI.Configuration>
```
It gives us a good summary on the tool we just built. Its name is "ArcMapAddin1" and its target is against ArcMap 10.3 running against .Net Framework Common Lauguage Runtime 4.0. This button control was given the caption as "My Button" and categorized under "Add-In Controls". Keep these in mind, you will need them later.

If we click the "Start" button with green arrow in VS2013, you should be able to see ArcMap is starting. VS2013 will do all the dirty jobs for us: invoke ArcMap 10.3 and attach the debugger to its process, load all necessary symbols from various assemblies to  facilitate debug...We are then ready to debug!

You can put a breakpoint on any line of source in Button1.cs, but nothing happens, right? It's because this control is a UI component and requires the user to click on it to invoke any action. So, where is our button? It is not on the UI! Well, it is really inconvenient and ESRI can do a better job by automatically adding the button onto the toolbar during debug. 

Anyway, we will have to do this manaully. You will need to go to Customize -> Add-In Manager, you should be able to see our button under "My Add-Ins", thanks to ESRI! The name should match the name in config.esriaddinx, the XML file that I ask you to pay attention.

Then, click on the button "Customize...", on Toolbars tab, you can create a new toolbar to hold our work. I created one called "Monkeybar", you can name it whatever, just make sure it won't duplicate the existing ones in ArcMap. Switch to Commands tab, the left pane lists all available categories, remember what I told you to remember? The category name is "Add-In Controls"! If you click on it, on the right side, you should be able to see "My Button" as the command. 

Now you can drag "My Button" onto your new toolbar! Next step will be adding some layers onto the map. The quickest way to do it is by adding a basemap which will bring in the coordinate system as well. I chose ESRI World Topo. It has a web Mercator type of projection. You can find my mxd file  [here](https://github.com/hellocomrade/arcobject/blob/master/lesson1/lesson1.mxd) 

Now if you click the button (By default, it is with a blue round icon), you should be able to see four red round dots showing on the four corners of the map. You may need to zoom to the full extent to see them. If you put a break point at line [59](https://github.com/hellocomrade/ArcObject/blob/master/lesson1/Button1.cs#L59) of Button1.cs and click our button in ArcMap, the execution will be suspended and you can do step by step debug on Button1.cs source inside VS2013.

You may notice that most of logics of Button1.cs are outside OnClick function. What if you want to debug the code, say, at line [33](https://github.com/hellocomrade/ArcObject/blob/master/lesson1/Button1.cs#L33)? Well, that function is called "the default contructor of the class" and only invoked once when this button is clicked the every first time. In order to debug the codes in there, we will have to termintate current debug session by clicking the red square button in VS 2013, then put a new breakpoint at line [33](https://github.com/hellocomrade/ArcObject/blob/master/lesson1/Button1.cs#L33) and start over again.

BTW, can anyone tell me what the line [36](https://github.com/hellocomrade/ArcObject/blob/master/lesson1/Button1.cs#L36) means? What is the section on the right side of += sign for? If you don't know, it is time to go over C# before you move onto future lessons.

## Lesson 2: Get the Heavy Work Done Outside ArcMap ##
When Arcpy was released, one of the exciting things is that GISers are allowed to get the data processing work done without having ArcMap opening. AO allows you to do so from day one, you just need a little bit more programming effort:)

In this session, we are going to develop a Windows Command Line application that is able to run without ArcMap involved (This is not completely true: if you don't have ArcEngine license, you still have to have ArcMap installed on the system in order to gain the license access). Anyway, let's close eyes and pretent ArcMap is off the radar here.

In order to make a fun case, I decided to play with some real data from [Great Lakes Restoration Database](http://habitat.glc.org/). Through its [Map Interface](http://habitat.glc.org/glrd/viewer.php), you can download all GLRD projects in csv format. We will take this dump as the source data. Each row of this file contains a project record with lat/lon, which we can convert it into a point feature class. If you are a GISer, you probably have done this hundreds of times, you may ask: what the fun part of that? Allright, let's add some fun: what if I only want to extract the project for the state of Michigan? Well, if you still have trouble to find the place to download this csv file, please click [here](http://habitat.glc.org/glrd/glc-search.php?download=1&all=1).

Let's go back to VS2013. FILE -> Project, on the left pane inside New Project window: Installed -> Templates -> Visual C# -> ArcGIS, if you click on "Extending ArcObjects", the central pane will display all available template, please choose "Console Application (Desktop)". You should see "ArcGIS Project Wizard" showing up, on the first page, we will keep everything as default and click "Next". Then, you will need to choose the license type for your ESRI products so the program knows what components can be built into your program. I chose "Advanced" then click Finish to get the template loaded.

If you open "Solution Explorer", you should see two cs files created by ESRI. Please replace "Program.cs" with [this](https://github.com/hellocomrade/ArcObject/blob/master/lesson2/Program.cs). Again, before you build the program, you will have to add some extra refereces. Remebmer the 1st step of "ArcGIS Project Wizard"? I convinced you to skip it, you actually could load extra references there.

1.ESRI.ArcGIS.Version;
2.ESRI.ArcGIS.Geodatabase;
3.ESRI.ArcGIS.Geometry

Now, you should be able to build the program. This tool is supposed to run under command line with two arguments:

C:\DesktopConsoleApplication1.exe glrd.csv michigan

The first argument is the path to the csv file you just downloaded, the second one is the State name. If you fail to feed these two arguments, the program will terminate immediately. Then, you may ask: how could I set this up insdie VS2013? In Solution Explorer, right click on the project, then go to "properties", under Debug, put the arguments inside "Command line arguments". By doing so, everytime you debug the program, the stuff you put there will be fed to it.

This is a "standalone" app and we will put our focus on the [code](https://github.com/hellocomrade/ArcObject/blob/master/lesson2/Program.cs). There are two tasks done in the code:

1. Parse an Excel csv file using SQL query;
2. Create a file Geodatabase and populate it with point geometry and attributes;
 
The first task is necessary if we have to filter the content first. For the case I set up, we'd like to find out only the projects in a single Great Lakes State. We achieved this at Line [33](https://github.com/hellocomrade/ArcObject/blob/master/lesson2/Program.cs#L33) by using OleDbCommand against Excel. Microsoft offers a very neat approach to manipluate Excel data using SQL statement. I highly recommend it to your programming work.

If we find positive number of projects for a state, we can go ahead to put them inside a geodatabase. Please pay attention on the flow of this process:

1. Get the factory that is able to create file-based geodatabase, see line [135](https://github.com/hellocomrade/ArcObject/blob/master/lesson2/Program.cs#L135).  
2. Create new feature class at line [147](https://github.com/hellocomrade/ArcObject/blob/master/lesson2/Program.cs#L147).
3. Loop the project records, create new feature and then insert them into the feature class through FeatureBuffer and FeatureCursor,
   which are recommended for bulk insertion. See line [156](https://github.com/hellocomrade/ArcObject/blob/master/lesson2/Program.cs#L156). Once the loop is done, flush the curosr to write all records back to disk.

During the feature class creation, you will have to define:

1. GeometryType;
2. Spatial Reference;
3. Fields as attributes;

This is a pretty standard procedure. I am surprised that ESRI doesn't have a snippet or code sample for this. I only find [this](https://github.com/Esri/developer-support/blob/master/arcobjects-net/display-XY-data-from-CSV/DisplayXYData.cs) at ESRI github account. Be aware that sample uses "esriDataSourcesFile.TextFileWorkspaceFactory", which freed the programmer from dealing with csv file directly. However, the freedom always comes from the understanding of the system. With the approach I introduced, you now have more flexibility to deal with Excel file.

Before we wrap up, let's go back the default template ESRI offers to us:
```c#
//ESRI License Initializer generated code.
m_AOLicenseInitializer.InitializeApplication(new esriLicenseProductCode[] { esriLicenseProductCode.esriLicenseProductCodeAdvanced },
                                        new esriLicenseExtensionCode[] { esriLicenseExtensionCode.esriLicenseExtensionCodeNetwork,                                           esriLicenseExtensionCode.esriLicenseExtensionCodeSpatialAnalyst });
                    ....................
//ESRI License Initializer generated code.
//Do not make any call to ArcObjects after ShutDownApplication()
m_AOLicenseInitializer.ShutdownApplication();
```
These are the routines for initializing ESRI components including licenese, then shut everything down at the end. Your code that involves ESRI stuff should be written in between.

Before we dismiss, could you please take a look on the signature of function [ParseCSV](https://github.com/hellocomrade/ArcObject/blob/master/lesson2/Program.cs#L22), what does List<dynamic> mean? If you read the code carefully, what's the type of the stuff we throw into the List at line [38](https://github.com/hellocomrade/ArcObject/blob/master/lesson2/Program.cs#L22)? Again, if you have no idea, your C# knowloedge needs to be updated!

OK, we are all done. Until next time, may the force be with you!
